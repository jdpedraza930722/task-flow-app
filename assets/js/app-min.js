import{dom as e}from"./modules/dom.js";import{state as t,loadData as a,saveData as s,setTimeToZero as n,parseDateString as i,formatDateToYYYYMMDD as l,getFilteredAndSortedTasks as r}from"./modules/state.js";import{renderAll as d,renderBinnedTasks as o,applyTheme as c,applyAccentColor as p,applyTranslations as u,showConfirmModal as g,closeConfirmModal as k,setupPersonalization as v}from"./modules/ui.js";async function main(){async function m(e){try{let a=await fetch(`./assets/js/modules/i18n/${e}.json`);if(!a.ok)throw Error(`Could not load ${e}.json`);t.translations=await a.json(),t.currentLanguage=e,localStorage.setItem("language",e),u()}catch(s){console.error("Failed to load language file:",s),"en"!==e&&await m("en")}}function f(e="plain"){let a=r(),s=`${t.translations.headerTitle} (${t.selectedDate.toLocaleDateString(t.currentLanguage)})`;if(0===a.length)return"No hay tareas para exportar.";if("csv"===e){let n="Estado;Tarea;Prioridad;Fecha de Vencimiento\n";return a.forEach(e=>{let a=e.completed?"Completada":"Pendiente",s=`priority${e.priority.charAt(0).toUpperCase()+e.priority.slice(1)}`,i=t.translations[s]||"Normal",l=e.dueDate?new Date(e.dueDate).toLocaleDateString(t.currentLanguage):"N/A";n+=`"${a}";"${e.text}";"${i}";"${l}"
`}),n}let i=s+"\n---------------------\n";return a.forEach(e=>{let t=e.completed?"[x]":"[ ]";i+=`${t} ${e.text}
`}),i}function y(e,t,a){let s=new Blob([t],{type:a}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}async function b(e){let a=f(),s=encodeURIComponent(a);if("native"===e&&navigator.share)try{await navigator.share({title:t.translations.headerTitle,text:a})}catch(n){console.error("Error al compartir:",n)}else if("whatsapp"===e)window.open(`https://wa.me/?text=${s}`,"_blank");else if("telegram"===e)window.open(`https://t.me/share/url?url=&text=${s}`,"_blank");else if("copy"===e||"native"===e&&!navigator.share)try{await navigator.clipboard.writeText(a),alert("es"===t.currentLanguage?"\xa1Texto copiado al portapapeles!":"Text copied to clipboard!")}catch(i){alert("es"===t.currentLanguage?"No se pudo copiar el texto.":"Could not copy text.")}}async function L(){t.selectedDate=n(new Date),a();let u=localStorage.getItem("language")||navigator.language.split("-")[0];["es","en","fr"].includes(u)||(u="en"),v();let L=JSON.parse(localStorage.getItem("accentColor"));p(L||{h:210,s:"79%",l:"61%"});let h=localStorage.getItem("theme"),x=window.matchMedia("(prefers-color-scheme: dark)").matches;c(h||(x?"dark":"light")),function a(){e.footer.addEventListener("click",a=>{if(a.preventDefault(),a.target.matches(".footer-link")){var s;let n=a.target.dataset.page;s=n,e.mainApp.style.display="none",e.pagesContainer.style.display="block",e.pageTitle.setAttribute("data-i18n-key",`pageTitle${s.charAt(0).toUpperCase()+s.slice(1)}`),e.pageContent.innerHTML=t.translations[`${s}Content`],e.pageTitle.textContent=t.translations[`pageTitle${s.charAt(0).toUpperCase()+s.slice(1)}`]}}),e.pagesContainer.addEventListener("click",t=>{t.target.matches(".page-back-btn")&&(e.pagesContainer.style.display="none",e.mainApp.style.display="block")}),e.prevWeekBtn.addEventListener("click",()=>{t.selectedDate.setDate(t.selectedDate.getDate()-7),d()}),e.nextWeekBtn.addEventListener("click",()=>{t.selectedDate.setDate(t.selectedDate.getDate()+7),d()}),e.daySelector.addEventListener("click",e=>{let a=e.target.closest(".day-btn");a&&(t.selectedDate=i(a.dataset.date),d())}),e.taskForm.addEventListener("submit",a=>{a.preventDefault();let n=e.taskInput.value.trim();n&&(function a(n){let i={id:Date.now(),text:n,completed:!1,priority:"normal",dueDate:t.selectedDate};t.tasks.unshift(i),s(),d();let l=e.taskList.querySelector(`[data-id='${i.id}']`);l&&(l.classList.add("task-item--new"),l.addEventListener("animationend",()=>l.classList.remove("task-item--new"),{once:!0}))}(n),e.taskInput.value="")}),e.filterControls.addEventListener("click",a=>{a.target.matches(".filter-btn")&&(e.filterControls.querySelector(".active").classList.remove("active"),a.target.classList.add("active"),t.currentFilter=a.target.dataset.filter,d())}),e.searchInput.addEventListener("input",e=>{t.searchTerm=e.target.value,d()}),e.sortSelect.addEventListener("change",e=>{t.currentSort=e.target.value,d()}),e.taskList.addEventListener("click",a=>{let n=a.target.closest(".task-list__item");if(!n)return;let i=Number(n.dataset.id);if(a.target.closest(".task-list__delete-button"))g("binTitle","taskDeletedConfirmation",()=>{let e=t.tasks.findIndex(e=>e.id===i);if(e>-1){let[a]=t.tasks.splice(e,1);t.binnedTasks.push(a),s(),d()}});else if(a.target.matches(".task-list__checkbox")){let r=t.tasks.find(e=>e.id===i);r&&(r.completed=a.target.checked,r.completedAt=a.target.checked?new Date().toISOString():null,s(),d())}else if(a.target.closest(".task-list__edit-button"))n.classList.add("editing"),n.querySelector(".task-list__edit-input").focus();else if(a.target.closest(".task-list__priority-button"))t.taskToModifyId=i,e.priorityModalOverlay.classList.add("visible");else if(a.target.closest(".task-list__duedate-button")){t.taskToModifyId=i;let o=t.tasks.find(e=>e.id===i);e.duedateInput.value=l(o.dueDate),e.duedateModalOverlay.classList.add("visible")}});let n=e=>{let a=e.closest(".task-list__item");if(!a)return;let n=Number(a.dataset.id),i=t.tasks.find(e=>e.id===n);if(!i)return;let l=e.value.trim();l?i.text=l:t.tasks=t.tasks.filter(e=>e.id!==n),s(),d()};e.taskList.addEventListener("blur",e=>{e.target.matches(".task-list__edit-input")&&n(e.target)},!0),e.taskList.addEventListener("keydown",e=>{"Enter"===e.key&&e.target.matches(".task-list__edit-input")&&e.target.blur()}),e.priorityOptions.addEventListener("click",a=>{let n=a.target.closest(".priority-option")?.dataset.priority;if(n&&t.taskToModifyId){let i=t.tasks.find(e=>e.id===t.taskToModifyId);i&&(i.priority=n),e.priorityModalOverlay.classList.remove("visible"),t.taskToModifyId=null,s(),d()}}),e.saveDuedateBtn.addEventListener("click",()=>{if(t.taskToModifyId){let a=t.tasks.find(e=>e.id===t.taskToModifyId);a&&(a.dueDate=i(e.duedateInput.value)),e.duedateModalOverlay.classList.remove("visible"),t.taskToModifyId=null,s(),d()}}),e.removeDuedateBtn.addEventListener("click",()=>{if(t.taskToModifyId){let a=t.tasks.find(e=>e.id===t.taskToModifyId);a&&(a.dueDate=null),e.duedateModalOverlay.classList.remove("visible"),t.taskToModifyId=null,s(),d()}}),e.confirmAcceptBtn.addEventListener("click",()=>{t.onConfirmCallback&&t.onConfirmCallback(),k()}),e.confirmCancelBtn.addEventListener("click",k),e.openBinBtn.addEventListener("click",()=>{o(),e.binModalOverlay.classList.add("visible")}),e.openBinBtn.addEventListener("contextmenu",a=>{a.preventDefault();let s=0===t.binnedTasks.length;e.binContextMenuRestore.classList.toggle("disabled",s),e.binContextMenuEmpty.classList.toggle("disabled",s),e.binContextMenu.style.top=`${a.pageY}px`,e.binContextMenu.style.left=`${a.pageX}px`,e.binContextMenu.style.display="block"}),e.binContextMenu.addEventListener("click",a=>{if(a.target.classList.contains("disabled"))return;let n=a.target.dataset.action;if(e.binContextMenu.style.display="none","empty"===n&&t.binnedTasks.length>0)g("binEmpty","emptyBinConfirmation",()=>{t.binnedTasks=[],s(),d(),o()});else if("restore-all"===n&&t.binnedTasks.length>0)g("binRestoreAll","restoreAllConfirmation",()=>{t.tasks.push(...t.binnedTasks),t.binnedTasks=[],s(),d()});else if("properties"===n){if(e.propItemCount.textContent=`${t.binnedTasks.length}`,t.binnedTasks.length>0){let i=t.binnedTasks.map(e=>e.id);e.propOldestItem.textContent=new Date(Math.min(...i)).toLocaleString(t.currentLanguage),e.propNewestItem.textContent=new Date(Math.max(...i)).toLocaleString(t.currentLanguage)}else e.propOldestItem.textContent="N/A",e.propNewestItem.textContent="N/A";e.propertiesModalOverlay.classList.add("visible")}}),e.emptyBinBtn.addEventListener("click",()=>{t.binnedTasks.length>0&&g("binEmpty","emptyBinConfirmation",()=>{t.binnedTasks=[],s(),d(),o()})}),e.binList.addEventListener("click",e=>{let a=e.target.closest(".bin-list__item");if(a&&e.target.closest(".bin-list__restore-btn")){let n=Number(a.dataset.id),i=t.binnedTasks.findIndex(e=>e.id===n);if(i>-1){let[l]=t.binnedTasks.splice(i,1);t.tasks.push(l),s(),d(),o()}}}),e.themeToggle.addEventListener("change",()=>c(document.body.classList.contains("dark-mode")?"light":"dark")),e.openSettingsBtn.addEventListener("click",()=>e.settingsModalOverlay.classList.add("visible")),e.languageSelect.addEventListener("change",e=>m(e.target.value)),e.colorPalette.addEventListener("click",e=>{if(e.target.classList.contains("color-swatch")){let t={h:e.target.dataset.hue,s:e.target.dataset.saturation,l:e.target.dataset.lightness};p(t)}}),e.openHelpBtn.addEventListener("click",()=>e.helpModalOverlay.classList.add("visible")),e.openAboutBtn.addEventListener("click",()=>e.aboutModalOverlay.classList.add("visible")),e.openExportBtn.addEventListener("click",()=>e.exportModalOverlay.classList.add("visible")),e.exportModalOverlay.addEventListener("click",a=>{if(a.target.matches(".export-btn")){let s=a.target.dataset.export,n=a.target.dataset.share;"txt"===s?y("tareas.txt",f(),"text/plain;charset=utf-8"):"csv"===s?y("tareas.csv",f("csv"),"text/csv;charset=utf-8"):"pdf"===s&&function e(){try{let{jsPDF:a}=window.jspdf,s=new a,n=r(),i=`${t.translations.headerTitle} (${t.selectedDate.toLocaleDateString(t.currentLanguage)})`;s.setFontSize(18),s.text(i,14,22),s.setFontSize(11);let l=30;n.forEach(e=>{l>280&&(s.addPage(),l=20);let t=e.completed?"âœ“":"o",a=`${t} ${e.text}`,n=s.splitTextToSize(a,180);s.text(n,14,l),l+=6*n.length+4}),s.save("lista_de_tareas.pdf")}catch(d){console.error("Error al generar PDF:",d),alert("Error al generar el PDF. Aseg\xfarate de que la librer\xeda jsPDF est\xe1 cargada.")}}(),n&&b(n),e.exportModalOverlay.classList.remove("visible")}}),document.addEventListener("click",t=>{t.target.closest("#open-bin-btn")||(e.binContextMenu.style.display="none"),(t.target.matches("[data-close]")||t.target.classList.contains("modal-overlay"))&&t.target.closest(".modal-overlay").classList.remove("visible")})}(),await m(u)}L()}document.addEventListener("DOMContentLoaded",main);